name: Release Chart

on:
  push:
    tags:
      - '*-[0-9]+.[0-9]+.[0-9]+'

env:
  REGISTRY: ghcr.io
  REGISTRY_PATH: ghcr.io/helmcode/helm-charts

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract chart info from tag
        id: chart
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          CHART_NAME="${TAG%-*}"
          CHART_VERSION="${TAG##*-}"
          echo "name=$CHART_NAME" >> $GITHUB_OUTPUT
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "path=charts/$CHART_NAME" >> $GITHUB_OUTPUT

      - name: Validate chart exists
        run: |
          if [ ! -f "${{ steps.chart.outputs.path }}/Chart.yaml" ]; then
            echo "Error: Chart '${{ steps.chart.outputs.name }}' not found at ${{ steps.chart.outputs.path }}"
            exit 1
          fi

      - name: Validate version matches
        run: |
          CHART_VERSION=$(grep '^version:' ${{ steps.chart.outputs.path }}/Chart.yaml | awk '{print $2}')
          if [ "$CHART_VERSION" != "${{ steps.chart.outputs.version }}" ]; then
            echo "Error: Tag version '${{ steps.chart.outputs.version }}' does not match Chart.yaml version '$CHART_VERSION'"
            exit 1
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint chart
        run: helm lint ${{ steps.chart.outputs.path }}

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Package and push chart
        run: |
          helm package ${{ steps.chart.outputs.path }}
          helm push ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz oci://${{ env.REGISTRY_PATH }}
